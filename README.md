# Лабораторная работа №7 — Архитектура, слои и DDD-lite

## Описание проекта

Реализация системы оплаты заказа с использованием слоистой архитектуры и принципов Domain-Driven Design (DDD-lite).

## Структура проекта
```
lab7-ddd-architecture/
├── domain/               # Доменный слой
│   ├── money.py             # Value Object - денежная сумма
│   ├── order_status.py      # Enum статусов заказа
│   ├── order_line.py        # Строка заказа (часть агрегата)
│   └── order.py             # Сущность Order (корень агрегата)
├── application/          # Слой приложения
│   ├── interfaces.py          # Интерфейсы репозитория и шлюза
│   └── pay_order_use_case.py  # Use-case оплаты заказа
├── infrastructure/       # Инфраструктурный слой
│   ├── in_memory_order_repository.py  # Реализация репозитория
│   └── fake_payment_gateway.py        # Фейковый платёжный шлюз
└── tests/                # Тесты
    └── test_pay_order.py   # Тесты use-case
```

## Слои архитектуры

### Domain (доменный слой)

Содержит бизнес-логику и правила предметной области:

- **Money** — Value Object для представления денежных сумм. Неизменяемый, поддерживает сложение.
- **OrderStatus** — перечисление статусов: DRAFT, PAID, CANCELLED.
- **OrderLine** — строка заказа с продуктом, количеством и ценой.
- **Order** — сущность заказа, корень агрегата. Инкапсулирует бизнес-правила.

### Application (слой приложения)

Содержит use-cases и интерфейсы:

- **OrderRepository** — интерфейс для работы с хранилищем заказов.
- **PaymentGateway** — интерфейс платёжного шлюза.
- **PayOrderUseCase** — сценарий оплаты заказа.

### Infrastructure (инфраструктурный слой)

Содержит реализации интерфейсов:

- **InMemoryOrderRepository** — хранение заказов в памяти.
- **FakePaymentGateway** — имитация платёжного шлюза для тестов.

## Реализованные инварианты

1. **Нельзя оплатить пустой заказ** — при попытке оплаты заказа без строк выбрасывается исключение.

2. **Нельзя оплатить заказ повторно** — повторный вызов `pay()` на оплаченном заказе вызывает ошибку.

3. **После оплаты нельзя менять строки заказа** — методы `add_line()` и `remove_line()` проверяют статус.

4. **Итоговая сумма равна сумме строк** — свойство `total` вычисляется динамически.

## Принципы проектирования

- **DIP (Dependency Inversion Principle)** — use-case зависит от абстракций (интерфейсов), а не от конкретных реализаций.
- **SRP (Single Responsibility Principle)** — каждый класс отвечает за одну задачу.
- **Rich Domain Model** — бизнес-логика находится в доменных объектах, а не в сервисах.

## Запуск тестов
```bash
pip install pytest
pytest tests/test_pay_order.py -v
```

## Тесты

| Тест | Описание |
|------|----------|
| test_successful_payment | Успешная оплата корректного заказа |
| test_empty_order_payment_fails | Ошибка при оплате пустого заказа |
| test_double_payment_fails | Ошибка при повторной оплате |
| test_cannot_modify_paid_order | Невозможность изменения после оплаты |
| test_correct_total_calculation | Корректный расчёт итоговой суммы |
| test_order_not_found | Ошибка при несуществующем заказе |
| test_payment_gateway_failure | Обработка ошибки платёжного шлюза |
